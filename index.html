<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è·‘æ­¥æ•™ç·´ç¯€æ‹å™¨ V2.2 - é«˜éˆæ•ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root { --primary: #ff6a00; --bg: #f4f7f9; --card: #ffffff; }
body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #333; padding: 15px; margin: 0; }
.card { background: var(--card); border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; }
h2 { color: var(--primary); margin: 0 0 10px 0; text-align: center; font-size: 1.2rem; }
table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 14px; }
th, td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: center; }
input { width: 50px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 16px; }
.display-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
.stat-box { background: #fff8f4; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #ffe0cc; }
.stat-val { font-size: 24px; font-weight: bold; color: var(--primary); display: block; font-family: monospace; }
.stat-label { font-size: 12px; color: #666; }
.btn-group { display: flex; gap: 10px; justify-content: center; }
button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
.btn-start { background: var(--primary); color: white; }
.btn-stop { background: #666; color: white; }
.btn-finish { background: #2ecc71; color: white; display: none; }
#status { text-align: center; font-weight: bold; padding: 10px; margin-top: 10px; border-radius: 8px; background: #eee; }
.overtime { background: #fff0f0 !important; border: 2px solid #e74c3c !important; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
.history-item { font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 8px 0; }
.info-text { font-size: 13px; color: #444; }
</style>
</head>
<body>

<div class="card">
  <h2>ğŸƒ è¨“ç·´è¨ˆç•«è¨­å®š</h2>
  <table id="planTable">
    <thead><tr><th>éšæ®µ</th><th>BPM</th><th>ç§’æ•¸</th></tr></thead>
    <tbody id="planBody"></tbody>
  </table>
  <div style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between;" class="info-text">
    <div>
      <label>å¾ªç’°çµ„æ•¸ï¼š</label>
      <input id="loopCount" type="number" value="5" oninput="updateLoops(this.value)">
    </div>
    <div style="font-weight: bold;">
      é è¨ˆåˆè¨ˆï¼š<span id="totalPlanTime" style="color: var(--primary);">0</span> åˆ†é˜
    </div>
  </div>
</div>

<div class="card" id="displayCard">
  <div class="display-grid">
    <div class="stat-box"><span class="stat-label">å·²ç”¨æ™‚é–“</span><span id="elapsed" class="stat-val">00:00</span></div>
    <div class="stat-box"><span class="stat-label">ç´¯ç©è·é›¢ (km)</span><span id="distance" class="stat-val">0.00</span></div>
    <div class="stat-box"><span class="stat-label">ç›®å‰é…é€Ÿ</span><span id="pace" class="stat-val">--:--</span></div>
    <div class="stat-box"><span class="stat-label">æœ¬æ®µå‰©é¤˜</span><span id="countdown" class="stat-val">--</span></div>
  </div>
  <div id="status">æº–å‚™å°±ç·’</div>
  <p id="gpsInfo" style="font-size: 10px; color: #999; text-align: center; margin: 8px 0 0 0;">GPS ç­‰å¾…å•Ÿå‹•...</p>
</div>

<div class="btn-group">
  <button id="mainBtn" onclick="toggleStart()" class="btn-start">é–‹å§‹è¨“ç·´</button>
  <button id="finishBtn" onclick="requestSave()" class="btn-finish">çµæŸä¸¦å„²å­˜</button>
</div>

<div class="card" style="margin-top: 20px;">
  <strong>æ­·å²ç´€éŒ„ (å¯åŒ¯å‡º TCX)</strong>
  <div id="historyList"></div>
</div>

<script>
/* ---------------- é è¨­è¨­å®šèˆ‡è¨˜æ†¶åŠŸèƒ½ ---------------- */
const DEFAULT_PLAN = [
  { name: 'ç†±èº«', bpm: 180, sec: 180 },
  { name: 'ç‡ƒè„‚', bpm: 190, sec: 30 },
  { name: 'é–“æ­‡', bpm: 210, sec: 40 },
  { name: 'è¶…æ…¢è·‘', bpm: 180, sec: 110 },
  { name: 'èˆ’ç·©', bpm: 180, sec: 180 }
];

let config = JSON.parse(localStorage.getItem('run_config_v2.2')) || { plan: DEFAULT_PLAN, loops: 5 };

function initTable() {
  const body = document.getElementById('planBody');
  body.innerHTML = config.plan.map((s, i) => `
    <tr>
      <td>${s.name}</td>
      <td><input type="number" value="${s.bpm}" oninput="updateConfig(${i}, 'bpm', this.value)"></td>
      <td><input type="number" value="${s.sec}" oninput="updateConfig(${i}, 'sec', this.value)"></td>
    </tr>
  `).join('');
  document.getElementById('loopCount').value = config.loops;
  calcTotalPlanTime();
}

function updateConfig(idx, key, val) {
  config.plan[idx][key] = parseInt(val) || 0;
  localStorage.setItem('run_config_v2.2', JSON.stringify(config));
  calcTotalPlanTime();
}

function updateLoops(val) {
  config.loops = parseInt(val) || 1;
  localStorage.setItem('run_config_v2.2', JSON.stringify(config));
  calcTotalPlanTime();
}

function calcTotalPlanTime() {
  const p = config.plan;
  const totalSec = p[0].sec + ((p[1].sec + p[2].sec + p[3].sec) * config.loops) + p[4].sec;
  document.getElementById('totalPlanTime').innerText = (totalSec / 60).toFixed(1);
}

/* ---------------- æ ¸å¿ƒè®Šæ•¸ ---------------- */
let isRunning = false;
let isOvertime = false;
let elapsedSec = 0;
let totalDist = 0;
let watchId = null;
let timerId = null;
let trackPoints = [];
let audioCtx = null;
let lastPos = null;

/* ---------------- GPS & è·é›¢å„ªåŒ– ---------------- */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function startGPS() {
  if (!navigator.geolocation) return;
  const options = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };
  
  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude, accuracy } = pos.coords;
    const now = new Date();
    document.getElementById('gpsInfo').innerText = `ç²¾åº¦: Â±${Math.round(accuracy)}m | æ›´æ–°: ${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
    
    if (accuracy < 60) {
      if (lastPos) {
        const d = haversine(lastPos.lat, lastPos.lon, latitude, longitude);
        // å„ªåŒ–ï¼šé‡å°è¶…æ…¢è·‘ï¼Œå°‡é–€æª»ä¸‹ä¿®è‡³ 0.3 å…¬å°º
        if (d > 0.3 && d < 50) { 
          totalDist += d;
          document.getElementById('distance').innerText = (totalDist / 1000).toFixed(3); // å¢åŠ ä¸€ä½å°æ•¸
          updatePace();
        }
      }
      lastPos = { lat: latitude, lon: longitude };
      trackPoints.push({ lat: latitude, lon: longitude, time: now.toISOString(), dist: totalDist });
    }
  }, err => {
    document.getElementById('gpsInfo').innerText = "GPS éŒ¯èª¤: " + err.message;
  }, options);
}

/* ---------------- ç¯€æ‹å™¨é‚è¼¯ ---------------- */
function playBeep() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.frequency.value = 1000; gain.gain.value = 0.4;
    osc.start(); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    osc.stop(audioCtx.currentTime + 0.12);
  } catch(e) {}
}

async function runSession() {
  isRunning = true;
  elapsedSec = 0;
  totalDist = 0;
  trackPoints = [];
  lastPos = null;
  startGPS();
  
  timerId = setInterval(() => {
    elapsedSec++;
    document.getElementById('elapsed').innerText = formatTime(elapsedSec);
  }, 1000);

  const plan = config.plan;
  const loops = config.loops;

  await performStage(plan[0], "ğŸƒ ç†±èº«ä¸­");
  for (let i = 1; i <= loops && isRunning; i++) {
    for (let j = 1; j <= 3 && isRunning; j++) {
      await performStage(plan[j], `ç¬¬ ${i}/${loops} çµ„: ${plan[j].name}`);
    }
  }
  if (isRunning) await performStage(plan[4], "ğŸš¶ èˆ’ç·©ä¸­");
  if (isRunning) enterOvertime(plan[4]);
}

async function performStage(stage, label) {
  if (!isRunning) return;
  document.getElementById('status').innerText = label;
  let remaining = stage.sec;
  const beatInterval = 60000 / stage.bpm;

  return new Promise(resolve => {
    let stageTimer = setInterval(() => {
      if (!isRunning) { clearInterval(stageTimer); resolve(); return; }
      remaining--;
      document.getElementById('countdown').innerText = (remaining >= 0) ? remaining : 0;
      if (remaining <= 0) { clearInterval(stageTimer); resolve(); }
    }, 1000);

    let beatTimer = setInterval(() => {
      if (!isRunning || remaining <= 0) { clearInterval(beatTimer); return; }
      playBeep();
    }, beatInterval);
  });
}

function enterOvertime(lastStage) {
  isOvertime = true;
  document.getElementById('status').innerText = "âœ¨ è¨“ç·´é”æ¨™ (æŒçºŒè¨ˆæ™‚èˆ‡é‡Œç¨‹)";
  document.getElementById('displayCard').classList.add('overtime');
  document.getElementById('finishBtn').style.display = 'block';
  document.getElementById('mainBtn').innerText = "åœæ­¢(ç¢ºèªæ•¸æ“š)";
  document.getElementById('mainBtn').className = "btn-stop";
  document.getElementById('countdown').innerText = "âˆ";

  const beatInterval = 60000 / lastStage.bpm;
  const overtimeBeat = setInterval(() => {
    if (!isRunning || !isOvertime) { clearInterval(overtimeBeat); return; }
    playBeep();
  }, beatInterval);
}

/* ---------------- å„²å­˜ç¢ºèªé‚è¼¯ ---------------- */
function toggleStart() {
  if (!isRunning) {
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    document.getElementById('mainBtn').innerText = "å¼·åˆ¶åœæ­¢";
    document.getElementById('mainBtn').className = "btn-stop";
    runSession();
  } else {
    requestSave(); // æŒ‰ä¸‹å¼·åˆ¶åœæ­¢ä¹Ÿé€²å…¥ç¢ºèªè¦–çª—
  }
}

function requestSave() {
  // å…ˆåœæ­¢æ‰€æœ‰è¨ˆæ™‚èˆ‡å®šä½
  isRunning = false;
  isOvertime = false;
  clearInterval(timerId);
  if (watchId) navigator.geolocation.clearWatch(watchId);

  // å½ˆå‡ºç¢ºèª/ä¿®æ­£è¦–çª—
  const currentKm = (totalDist / 1000).toFixed(3);
  const userConfirm = confirm(`è¨“ç·´å·²æš«åœã€‚\næœ¬æ¬¡ç´¯ç©è·é›¢ç‚º: ${currentKm} km\næ˜¯å¦éœ€è¦ä¿®æ­£è·é›¢å¾Œå„²å­˜ï¼Ÿ`);
  
  if (userConfirm) {
    const finalKm = prompt("è«‹è¼¸å…¥æœ€çµ‚è·é›¢ (km):", currentKm);
    if (finalKm !== null) {
      saveToHistory(parseFloat(finalKm));
      stopRun(true);
    } else {
      // ä½¿ç”¨è€…å–æ¶ˆ promptï¼Œè¦–åŒæ”¾æ£„å„²å­˜æˆ–æƒ³ç¹¼çºŒå›åˆ°æº–å‚™ç‹€æ…‹
      stopRun(false);
    }
  } else {
    // ä½¿ç”¨è€…é»é¸ã€Œå–æ¶ˆã€ï¼Œç›´æ¥ä¸å„²å­˜
    stopRun(false);
  }
}

function stopRun(isSaved) {
  isRunning = false;
  isOvertime = false;
  clearInterval(timerId);
  if (watchId) navigator.geolocation.clearWatch(watchId);
  
  document.getElementById('mainBtn').innerText = "é–‹å§‹è¨“ç·´";
  document.getElementById('mainBtn').className = "btn-start";
  document.getElementById('finishBtn').style.display = 'none';
  document.getElementById('displayCard').classList.remove('overtime');
  document.getElementById('status').innerText = isSaved ? "ç´€éŒ„å·²å„²å­˜" : "æº–å‚™å°±ç·’";
  // é‡ç½®æ•¸æ“š
  document.getElementById('distance').innerText = "0.00";
  document.getElementById('elapsed').innerText = "00:00";
}

function formatTime(s) {
  return Math.floor(s/60).toString().padStart(2,'0') + ":" + (s%60).toString().padStart(2,'0');
}

function updatePace() {
  if (totalDist < 5) return;
  const paceSec = elapsedSec / (totalDist / 1000);
  document.getElementById('pace').innerText = formatTime(Math.floor(paceSec));
}

function saveToHistory(finalKm) {
  const records = JSON.parse(localStorage.getItem('run_history_v2.2') || "[]");
  const newRec = {
    id: Date.now(),
    date: new Date().toLocaleString(),
    dist: finalKm.toFixed(2),
    time: formatTime(elapsedSec),
    points: trackPoints,
    rawSec: elapsedSec
  };
  records.unshift(newRec);
  localStorage.setItem('run_history_v2.2', JSON.stringify(records));
  renderHistory();
}

function exportTCX(id) {
  const records = JSON.parse(localStorage.getItem('run_history_v2.2'));
  const data = records.find(r => r.id === id);
  if (!data) return;

  let tcx = `<?xml version="1.0" encoding="UTF-8"?>
<TrainingCenterDatabase xmlns="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2">
  <Activities>
    <Activity Sport="Running">
      <Id>${new Date(data.id).toISOString()}</Id>
      <Lap StartTime="${new Date(data.id).toISOString()}">
        <TotalTimeSeconds>${data.rawSec}</TotalTimeSeconds>
        <DistanceMeters>${data.dist * 1000}</DistanceMeters>
        <Track>`;
  data.points.forEach(p => {
    tcx += `<Trackpoint><Time>${p.time}</Time><Position><LatitudeDegrees>${p.lat}</LatitudeDegrees><LongitudeDegrees>${p.lon}</LongitudeDegrees></Position><DistanceMeters>${p.dist.toFixed(1)}</DistanceMeters></Trackpoint>`;
  });
  tcx += `</Track></Lap></Activity></Activities></TrainingCenterDatabase>`;

  const blob = new Blob([tcx], { type: 'application/tcx+xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `Run_${data.id}.tcx`;
  a.click();
}

function renderHistory() {
  const records = JSON.parse(localStorage.getItem('run_history_v2.2') || "[]");
  document.getElementById('historyList').innerHTML = records.map(r => `
    <div class="history-item">
      <span>${r.date}<br><small>${r.dist}km / ${r.time}</small></span>
      <button onclick="exportTCX(${r.id})" style="padding:4px 8px; flex:none; font-size:12px; background:#eee; border:1px solid #ccc;">åŒ¯å‡º</button>
    </div>
  `).join('');
}

window.onload = () => { initTable(); renderHistory(); };
</script>
</body>
</html>
