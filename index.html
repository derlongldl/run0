<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è·‘æ­¥æ•™ç·´å°ˆæ¥­ç‰ˆ V2.5</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root { --primary: #ff6a00; --bg: #f4f7f9; --card: #ffffff; --danger: #e74c3c; --success: #2ecc71; --info: #3498db; }
body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #333; padding: 15px; margin: 0; }
.card { background: var(--card); border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; }
h2 { color: var(--primary); margin: 0 0 10px 0; text-align: center; font-size: 1.2rem; }
table { width: 100%; border-collapse: collapse; font-size: 14px; }
th, td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: center; }
input[type="number"] { width: 50px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 16px; }

/* æ•¸æ“šé¢æ¿ */
.display-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
.stat-box { background: #fff8f4; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #ffe0cc; }
.stat-val { font-size: 24px; font-weight: bold; color: var(--primary); display: block; font-family: monospace; }
.stat-label { font-size: 12px; color: #666; }

/* é–€æª»å¾®èª¿æ©«æ¢ */
.slider-container { margin-top: 15px; padding: 12px; background: #fff; border-radius: 10px; border: 2px solid #eee; }
input[type="range"] { width: 100%; height: 10px; border-radius: 5px; background: #eee; outline: none; -webkit-appearance: none; margin: 15px 0; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--primary); border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }

/* æŒ‰éˆ• */
.btn-finish { background: var(--success); color: white; width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; display: none; margin-top: 10px; }
.btn-start { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }

/* æ­·å²ç´€éŒ„ */
.history-card { background: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.history-btns { display: flex; gap: 5px; margin-top: 8px; }
button.sm { padding: 6px 12px; font-size: 12px; border-radius: 5px; border: none; cursor: pointer; color: white; }

#trackModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
canvas { background: #fff; border-radius: 10px; width: 90vw; height: 90vw; }
#status { text-align: center; font-weight: bold; padding: 10px; margin-top: 10px; border-radius: 8px; background: #eee; }
</style>
</head>
<body>

<div id="trackModal">
  <h3 style="color: white;">ğŸƒ è·‘æ­¥è»Œè·¡</h3>
  <canvas id="trackCanvas"></canvas>
  <button onclick="closeTrack()" style="margin-top:20px; padding:10px 40px; border-radius:20px; border:none;">é—œé–‰</button>
</div>

<div class="card">
  <h2>ğŸƒ è¨“ç·´è¨ˆç•«</h2>
  <table>
    <tbody id="planBody"></tbody>
  </table>
  <div style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between; font-size: 14px;">
    <div>å¾ªç’°ï¼š<input id="loopCount" type="number" oninput="updateLoops(this.value)"> çµ„</div>
    <div>é è¨ˆï¼š<span id="totalPlanTime" style="color:var(--primary); font-weight:bold;">0</span> åˆ†</div>
  </div>

  <div class="slider-container">
    <div style="display: flex; justify-content: space-between; font-size: 13px; font-weight: bold;">
      <span>ğŸ›¡ï¸ GPS éæ¿¾é–€æª» (æ•æ„Ÿåº¦)</span>
      <span id="thresholdDisplay" style="color: var(--primary);">0.30 m</span>
    </div>
    <input type="range" id="thresholdSlider" min="0.00" max="1.00" step="0.05" value="0.30" oninput="updateThreshold(this.value)">
    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #999;">
      <span>æ¥µåº¦æ•æ„Ÿ(0m)</span><span>æ­£å¸¸(0.3m)</span><span>ä½æ•æ„Ÿ(1m)</span>
    </div>
    <div style="font-size: 11px; color: #666; margin-top: 5px; text-align: center; line-height: 1.4;">
      â€» è¶…æ…¢è·‘å»ºè­°è¨­ç‚º <b>0.20 - 0.40m</b>ã€‚<br>è‹¥ç«™ç«‹ä¸å‹•é‡Œç¨‹ä»å¢åŠ ï¼Œè«‹å‘å³èª¿é«˜ã€‚
    </div>
  </div>
</div>

<div class="card">
  <div class="display-grid">
    <div class="stat-box"><span class="stat-label">æ™‚é–“</span><span id="elapsed" class="stat-val">00:00</span></div>
    <div class="stat-box"><span class="stat-label">é‡Œç¨‹ (km)</span><span id="distance" class="stat-val">0.000</span></div>
    <div class="stat-box"><span class="stat-label">å¹³å‡é…é€Ÿ</span><span id="pace" class="stat-val">--:--</span></div>
    <div class="stat-box"><span class="stat-label">æœ¬æ®µå‰©é¤˜</span><span id="countdown" class="stat-val">--</span></div>
  </div>
  <div id="status">æº–å‚™å°±ç·’</div>
  <p id="gpsInfo" style="font-size:10px; color:#999; text-align:center; margin-top:8px;">GPS ç­‰å¾…ä¸­</p>
</div>

<button id="startBtn" onclick="toggleStart()" class="btn-start">é–‹å§‹è¨“ç·´</button>
<button id="finishBtn" onclick="stopAndSave()" class="btn-finish">çµæŸä¸¦å„²å­˜ç´€éŒ„</button>

<div style="margin-top: 25px;">
  <strong>æ­·å²ç´€éŒ„</strong>
  <div id="historyList" style="margin-top: 10px;"></div>
</div>

<script>
/* ---------------- è¨­å®šèˆ‡è¨˜æ†¶ ---------------- */
const DEFAULT_PLAN = [
  { name: 'ç†±èº«', bpm: 180, sec: 180 }, { name: '200é–“æ­‡', bpm: 200, sec: 60 },
  { name: '210è¡åˆº', bpm: 210, sec: 60 }, { name: '190æ¢å¾©', bpm: 190, sec: 120 },
  { name: 'èˆ’ç·©', bpm: 180, sec: 180 }
];
let config = JSON.parse(localStorage.getItem('run_config_v2.5')) || { plan: DEFAULT_PLAN, loops: 5, threshold: 0.30 };

function initTable() {
  document.getElementById('planBody').innerHTML = config.plan.map((s, i) => `
    <tr><td><b>${s.name}</b></td>
    <td>BPM <input type="number" value="${s.bpm}" oninput="updateConfig(${i},'bpm',this.value)"></td>
    <td>ç§’æ•¸ <input type="number" value="${s.sec}" oninput="updateConfig(${i},'sec',this.value)"></td></tr>
  `).join('');
  document.getElementById('loopCount').value = config.loops;
  document.getElementById('thresholdSlider').value = config.threshold;
  document.getElementById('thresholdDisplay').innerText = parseFloat(config.threshold).toFixed(2) + " m";
  calcTotalPlanTime();
}
function updateConfig(i, k, v) { config.plan[i][k] = parseInt(v)||0; saveCfg(); }
function updateLoops(v) { config.loops = parseInt(v)||1; saveCfg(); }
function updateThreshold(v) { 
  config.threshold = parseFloat(v); 
  document.getElementById('thresholdDisplay').innerText = config.threshold.toFixed(2) + " m";
  saveCfg(); 
}
function saveCfg() { localStorage.setItem('run_config_v2.5', JSON.stringify(config)); calcTotalPlanTime(); }
function calcTotalPlanTime() {
  const p = config.plan;
  const sec = p[0].sec + ((p[1].sec + p[2].sec + p[3].sec) * config.loops) + p[4].sec;
  document.getElementById('totalPlanTime').innerText = (sec/60).toFixed(1);
}

/* ---------------- æ ¸å¿ƒè®Šæ•¸ ---------------- */
let isRunning = false, elapsedSec = 0, totalDist = 0;
let watchId = null, timerId = null, trackPoints = [], audioCtx = null, lastPos = null;

/* ---------------- GPS é‚è¼¯ (ä½¿ç”¨å³æ™‚èª¿æ•´çš„é–€æª») ---------------- */
function startGPS() {
  if (!navigator.geolocation) return;
  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude: lat, longitude: lon, accuracy } = pos.coords;
    document.getElementById('gpsInfo').innerText = `GPS ç²¾åº¦: Â±${Math.round(accuracy)}m (é–€æª»: ${config.threshold.toFixed(2)}m)`;
    if (accuracy < 60) {
      if (lastPos) {
        const d = haversine(lastPos.lat, lastPos.lon, lat, lon);
        // ä½¿ç”¨ config.threshold å‹•æ…‹åˆ¤å®š
        if (d > config.threshold && d < 50) { 
          totalDist += d;
          document.getElementById('distance').innerText = (totalDist/1000).toFixed(3);
          updatePaceDisplay();
        }
      }
      lastPos = { lat, lon };
      trackPoints.push({ lat, lon, time: new Date().toISOString(), dist: totalDist });
    }
  }, null, { enableHighAccuracy: true });
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ---------------- éŸ³æ•ˆ ---------------- */
function playBeep() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value = 1000; g.gain.value = 0.2;
  o.start(); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  o.stop(audioCtx.currentTime + 0.12);
}

/* ---------------- åŸ·è¡Œé‚è¼¯ ---------------- */
async function runSession() {
  isRunning = true; elapsedSec = 0; totalDist = 0; trackPoints = []; lastPos = null;
  startGPS();
  timerId = setInterval(() => { elapsedSec++; document.getElementById('elapsed').innerText = formatTime(elapsedSec); }, 1000);

  const p = config.plan;
  await performStage(p[0], "ğŸƒ ç†±èº«ä¸­");
  for (let i = 1; i <= config.loops && isRunning; i++) {
    for (let j = 1; j <= 3 && isRunning; j++) await performStage(p[j], `çµ„ ${i}: ${p[j].name}`);
  }
  if (isRunning) await performStage(p[4], "ğŸš¶ èˆ’ç·©ä¸­");
  if (isRunning) {
    document.getElementById('status').innerText = "âœ¨ è¨“ç·´é”æ¨™ï¼(æŒçºŒè¨ˆæ™‚)";
    document.getElementById('countdown').innerText = "âˆ";
    const bInt = 60000 / p[4].bpm;
    while(isRunning) { playBeep(); await new Promise(r => setTimeout(r, bInt)); }
  }
}

async function performStage(s, label) {
  if (!isRunning) return;
  document.getElementById('status').innerText = label;
  let rem = s.sec;
  const bInt = 60000 / s.bpm;
  return new Promise(res => {
    let t1 = setInterval(() => { 
      rem--; document.getElementById('countdown').innerText = rem>=0?rem:0; 
      if(rem<=0 || !isRunning){ clearInterval(t1); res(); }
    }, 1000);
    let t2 = setInterval(() => { if(!isRunning || rem<=0){ clearInterval(t2); return; } playBeep(); }, bInt);
  });
}

function toggleStart() {
  if(audioCtx) audioCtx.resume();
  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('finishBtn').style.display = 'block';
  runSession();
}

function stopAndSave() {
  isRunning = false;
  clearInterval(timerId);
  if (watchId) navigator.geolocation.clearWatch(watchId);
  
  // å­˜å…¥ç´€éŒ„
  if (totalDist > 0 || elapsedSec > 10) {
    const records = JSON.parse(localStorage.getItem('run_history_v2.5') || "[]");
    records.unshift({
      id: Date.now(), date: new Date().toLocaleString(),
      dist: (totalDist/1000).toFixed(3), time: formatTime(elapsedSec),
      points: trackPoints, rawSec: elapsedSec
    });
    localStorage.setItem('run_history_v2.5', JSON.stringify(records));
  }
  
  // é‡ç½® UI
  location.reload(); // é»æ“Šå„²å­˜å¾Œé‡æ–°æ•´ç†ç•«é¢æœ€ä¹¾æ·¨
}

/* ---------------- æ­·å²èˆ‡è¼”åŠ© ---------------- */
function renderHistory() {
  const records = JSON.parse(localStorage.getItem('run_history_v2.5') || "[]");
  document.getElementById('historyList').innerHTML = records.map(r => `
    <div class="history-card">
      <div style="font-size:12px; color:#888;">ğŸ“… ${r.date} | â±ï¸ ${r.time}</div>
      <div style="font-size:16px; font-weight:bold; margin:5px 0;">ğŸƒ ${r.dist} km</div>
      <div class="history-btns">
        <button class="sm" style="background:var(--info);" onclick="viewTrack(${r.id})">æŸ¥çœ‹è»Œè·¡</button>
        <button class="sm" style="background:var(--success);" onclick="editDist(${r.id})">ä¿®æ­£é‡Œç¨‹</button>
        <button class="sm" style="background:var(--danger);" onclick="deleteRec(${r.id})">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}

function editDist(id) {
  const records = JSON.parse(localStorage.getItem('run_history_v2.5'));
  const idx = records.findIndex(r => r.id === id);
  const newVal = prompt("ä¿®æ­£é‡Œç¨‹ (km):", records[idx].dist);
  if (newVal) { records[idx].dist = parseFloat(newVal).toFixed(3); localStorage.setItem('run_history_v2.5', JSON.stringify(records)); renderHistory(); }
}

function deleteRec(id) {
  if (confirm("åˆªé™¤ç´€éŒ„ï¼Ÿ")) {
    const records = JSON.parse(localStorage.getItem('run_history_v2.5')).filter(r => r.id !== id);
    localStorage.setItem('run_history_v2.5', JSON.stringify(records)); renderHistory();
  }
}

function viewTrack(id) {
  const r = JSON.parse(localStorage.getItem('run_history_v2.5')).find(r => r.id === id);
  if (!r.points || r.points.length < 2) return alert("ç´€éŒ„ä¸è¶³");
  document.getElementById('trackModal').style.display = 'flex';
  const cvs = document.getElementById('trackCanvas'), ctx = cvs.getContext('2d');
  cvs.width = window.innerWidth * 0.9; cvs.height = cvs.width;
  const lats = r.points.map(p => p.lat), lons = r.points.map(p => p.lon);
  const minLat = Math.min(...lats), maxLat = Math.max(...lats), minLon = Math.min(...lons), maxLon = Math.max(...lons);
  const rLat = maxLat - minLat || 0.0001, rLon = maxLon - minLon || 0.0001, pad = 50;
  ctx.clearRect(0,0,cvs.width,cvs.height); ctx.strokeStyle = '#ff6a00'; ctx.lineWidth = 5; ctx.lineJoin = 'round'; ctx.beginPath();
  r.points.forEach((pt, i) => {
    const x = pad + (pt.lon - minLon) / rLon * (cvs.width - pad * 2);
    const y = cvs.height - (pad + (pt.lat - minLat) / rLat * (cvs.height - pad * 2));
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();
}
function closeTrack() { document.getElementById('trackModal').style.display = 'none'; }
function formatTime(s) { return Math.floor(s/60).toString().padStart(2,'0')+":"+(s%60).toString().padStart(2,'0'); }
function updatePaceDisplay() { if(totalDist<10)return; document.getElementById('pace').innerText = formatTime(Math.floor(elapsedSec/(totalDist/1000))); }

window.onload = () => { initTable(); renderHistory(); };
</script>
</body>
</html>
