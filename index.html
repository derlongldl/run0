<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è·‘æ­¥æ•™ç·´å°ˆæ¥­ç‰ˆ V2.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root { --primary: #ff6a00; --bg: #f4f7f9; --card: #ffffff; --danger: #e74c3c; --success: #2ecc71; --info: #3498db; }
body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #333; padding: 15px; margin: 0; }
.card { background: var(--card); border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; }
h2 { color: var(--primary); margin: 0 0 10px 0; text-align: center; font-size: 1.2rem; }
table { width: 100%; border-collapse: collapse; font-size: 14px; }
th, td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: center; }
input { width: 50px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 16px; }

/* æ•¸æ“šé¢æ¿ */
.display-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
.stat-box { background: #fff8f4; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #ffe0cc; }
.stat-val { font-size: 24px; font-weight: bold; color: var(--primary); display: block; font-family: monospace; }
.stat-label { font-size: 12px; color: #666; }

/* æŒ‰éˆ•æ¨£å¼ */
.btn-group { display: flex; gap: 10px; justify-content: center; }
button { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.btn-start { background: var(--primary); color: white; flex: 2; }
.btn-stop { background: #666; color: white; flex: 2; }
.btn-finish { background: var(--success); color: white; display: none; flex: 2; }
.btn-sm { font-size: 12px; padding: 5px 8px; margin-left: 5px; color: white; }

/* æ­·å²ç´€éŒ„å¡ç‰‡ */
.history-card { background: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.history-meta { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 5px; }
.history-data { font-size: 16px; font-weight: bold; margin-bottom: 8px; }
.history-btns { display: flex; gap: 5px; flex-wrap: wrap; }

/* è»Œè·¡æŸ¥çœ‹å™¨ (å½ˆå‡ºå±¤) */
#trackModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
canvas { background: #fff; border-radius: 10px; max-width: 90%; max-height: 70vh; }

#status { text-align: center; font-weight: bold; padding: 10px; margin-top: 10px; border-radius: 8px; background: #eee; }
.overtime { background: #fff0f0 !important; border: 2px solid var(--danger) !important; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
</style>
</head>
<body>

<div id="trackModal">
  <h3 style="color: white;">è·‘æ­¥è»Œè·¡ç´€éŒ„</h3>
  <canvas id="trackCanvas"></canvas>
  <button onclick="closeTrack()" style="margin-top:20px; background:white; padding:10px 40px;">é—œé–‰</button>
</div>

<div class="card">
  <h2>ğŸƒ è¨“ç·´è¨­å®š</h2>
  <table>
    <thead><tr><th>éšæ®µ</th><th>BPM</th><th>ç§’æ•¸</th></tr></thead>
    <tbody id="planBody"></tbody>
  </table>
  <div style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between; font-size: 13px;">
    <div>å¾ªç’°çµ„æ•¸ï¼š<input id="loopCount" type="number" oninput="updateLoops(this.value)"></div>
    <div>é è¨ˆï¼š<span id="totalPlanTime" style="color:var(--primary); font-weight:bold;">0</span> åˆ†é˜</div>
  </div>
</div>

<div class="card" id="displayCard">
  <div class="display-grid">
    <div class="stat-box"><span class="stat-label">æ™‚é–“</span><span id="elapsed" class="stat-val">00:00</span></div>
    <div class="stat-box"><span class="stat-label">å…¬é‡Œ</span><span id="distance" class="stat-val">0.000</span></div>
    <div class="stat-box"><span class="stat-label">é…é€Ÿ</span><span id="pace" class="stat-val">--:--</span></div>
    <div class="stat-box"><span class="stat-label">å‰©é¤˜</span><span id="countdown" class="stat-val">--</span></div>
  </div>
  <div id="status">æº–å‚™å°±ç·’</div>
  <p id="gpsInfo" style="font-size:10px; color:#999; text-align:center; margin:8px 0 0 0;">GPS ç­‰å¾…ä¸­</p>
</div>

<div class="btn-group">
  <button id="mainBtn" onclick="toggleStart()" class="btn-start">é–‹å§‹è¨“ç·´</button>
  <button id="finishBtn" onclick="stopRun(true)" class="btn-finish">çµæŸä¸¦å„²å­˜</button>
</div>

<div style="margin-top: 20px;">
  <strong>æ­·å²è¨“ç·´ç´€éŒ„</strong>
  <div id="historyList" style="margin-top: 10px;"></div>
</div>

<script>
/* ---------------- åŸºç¤è¨­å®šèˆ‡è¨˜æ†¶ ---------------- */
const DEFAULT_PLAN = [
  { name: 'ç†±èº«', bpm: 180, sec: 180 }, { name: 'ç‡ƒè„‚', bpm: 190, sec: 30 },
  { name: 'é–“æ­‡', bpm: 210, sec: 40 }, { name: 'è¶…æ…¢è·‘', bpm: 180, sec: 110 },
  { name: 'èˆ’ç·©', bpm: 180, sec: 180 }
];
let config = JSON.parse(localStorage.getItem('run_config_v2.3')) || { plan: DEFAULT_PLAN, loops: 5 };

function initTable() {
  document.getElementById('planBody').innerHTML = config.plan.map((s, i) => `
    <tr><td>${s.name}</td>
    <td><input type="number" value="${s.bpm}" oninput="updateConfig(${i},'bpm',this.value)"></td>
    <td><input type="number" value="${s.sec}" oninput="updateConfig(${i},'sec',this.value)"></td></tr>
  `).join('');
  document.getElementById('loopCount').value = config.loops;
  calcTotalPlanTime();
}
function updateConfig(i, k, v) { config.plan[i][k] = parseInt(v)||0; saveCfg(); }
function updateLoops(v) { config.loops = parseInt(v)||1; saveCfg(); }
function saveCfg() { localStorage.setItem('run_config_v2.3', JSON.stringify(config)); calcTotalPlanTime(); }
function calcTotalPlanTime() {
  const p = config.plan;
  const sec = p[0].sec + ((p[1].sec + p[2].sec + p[3].sec) * config.loops) + p[4].sec;
  document.getElementById('totalPlanTime').innerText = (sec/60).toFixed(1);
}

/* ---------------- æ ¸å¿ƒè®Šæ•¸ ---------------- */
let isRunning = false, isOvertime = false, elapsedSec = 0, totalDist = 0;
let watchId = null, timerId = null, trackPoints = [], audioCtx = null, lastPos = null;

/* ---------------- GPS é‚è¼¯ ---------------- */
function startGPS() {
  if (!navigator.geolocation) return;
  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude: lat, longitude: lon, accuracy } = pos.coords;
    document.getElementById('gpsInfo').innerText = `ç²¾åº¦: Â±${Math.round(accuracy)}m`;
    if (accuracy < 60) {
      if (lastPos) {
        const d = haversine(lastPos.lat, lastPos.lon, lat, lon);
        if (d > 0.3 && d < 50) { 
          totalDist += d;
          document.getElementById('distance').innerText = (totalDist/1000).toFixed(3);
          updatePace();
        }
      }
      lastPos = { lat, lon };
      trackPoints.push({ lat, lon, time: new Date().toISOString(), dist: totalDist });
    }
  }, null, { enableHighAccuracy: true });
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ---------------- è¨“ç·´æµç¨‹ ---------------- */
function playBeep() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value = 1000; g.gain.value = 0.3;
  o.start(); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  o.stop(audioCtx.currentTime + 0.12);
}

async function runSession() {
  isRunning = true; elapsedSec = 0; totalDist = 0; trackPoints = []; lastPos = null;
  startGPS();
  timerId = setInterval(() => { elapsedSec++; document.getElementById('elapsed').innerText = formatTime(elapsedSec); }, 1000);

  const p = config.plan;
  await performStage(p[0], "ğŸƒ ç†±èº«ä¸­");
  for (let i = 1; i <= config.loops && isRunning; i++) {
    for (let j = 1; j <= 3 && isRunning; j++) await performStage(p[j], `ç¬¬ ${i}/${config.loops} çµ„: ${p[j].name}`);
  }
  if (isRunning) await performStage(p[4], "ğŸš¶ èˆ’ç·©ä¸­");
  if (isRunning) enterOvertime(p[4]);
}

async function performStage(s, label) {
  if (!isRunning) return;
  document.getElementById('status').innerText = label;
  let rem = s.sec;
  const bInt = 60000 / s.bpm;
  return new Promise(res => {
    let t1 = setInterval(() => { 
      rem--; document.getElementById('countdown').innerText = rem>=0?rem:0; 
      if(rem<=0 || !isRunning){ clearInterval(t1); res(); }
    }, 1000);
    let t2 = setInterval(() => { if(!isRunning || rem<=0){ clearInterval(t2); return; } playBeep(); }, bInt);
  });
}

function enterOvertime(lastS) {
  isOvertime = true;
  document.getElementById('status').innerText = "âœ¨ è¨“ç·´é”æ¨™ (æŒçºŒè¨˜éŒ„)";
  document.getElementById('displayCard').classList.add('overtime');
  document.getElementById('finishBtn').style.display = 'block';
  document.getElementById('mainBtn').innerText = "åœæ­¢ä¸¦å„²å­˜";
  document.getElementById('countdown').innerText = "âˆ";
  const bInt = 60000 / lastS.bpm;
  const t3 = setInterval(() => { if(!isRunning){ clearInterval(t3); return; } playBeep(); }, bInt);
}

/* ---------------- æŒ‰éˆ•å‹•ä½œ ---------------- */
function toggleStart() {
  if (!isRunning) {
    if(audioCtx) audioCtx.resume();
    document.getElementById('mainBtn').innerText = "å¼·åˆ¶åœæ­¢ä¸¦å„²å­˜";
    document.getElementById('mainBtn').className = "btn-stop";
    runSession();
  } else {
    stopRun(true); // ç›´æ¥å„²å­˜
  }
}

function stopRun(save) {
  if (save && (totalDist > 0 || elapsedSec > 10)) saveToHistory();
  isRunning = false; isOvertime = false;
  clearInterval(timerId);
  if (watchId) navigator.geolocation.clearWatch(watchId);
  document.getElementById('mainBtn').innerText = "é–‹å§‹è¨“ç·´";
  document.getElementById('mainBtn').className = "btn-start";
  document.getElementById('finishBtn').style.display = 'none';
  document.getElementById('displayCard').classList.remove('overtime');
  document.getElementById('status').innerText = save ? "ç´€éŒ„å·²è‡ªå‹•å„²å­˜" : "æº–å‚™å°±ç·’";
}

/* ---------------- æ­·å²ç´€éŒ„ç®¡ç† ---------------- */
function saveToHistory() {
  const records = JSON.parse(localStorage.getItem('run_history_v2.3') || "[]");
  records.unshift({
    id: Date.now(), date: new Date().toLocaleString(),
    dist: (totalDist/1000).toFixed(3), time: formatTime(elapsedSec),
    points: trackPoints, rawSec: elapsedSec
  });
  localStorage.setItem('run_history_v2.3', JSON.stringify(records));
  renderHistory();
}

function renderHistory() {
  const records = JSON.parse(localStorage.getItem('run_history_v2.3') || "[]");
  document.getElementById('historyList').innerHTML = records.map(r => `
    <div class="history-card">
      <div class="history-meta"><span>ğŸ“… ${r.date}</span><span>â±ï¸ ${r.time}</span></div>
      <div class="history-data">ğŸƒ <span id="dist-${r.id}">${r.dist}</span> km</div>
      <div class="history-btns">
        <button onclick="viewTrack(${r.id})" style="background:var(--info); color:white;">æŸ¥çœ‹è»Œè·¡</button>
        <button onclick="editDist(${r.id})" style="background:var(--success); color:white;">ä¿®æ­£é‡Œç¨‹</button>
        <button onclick="exportTCX(${r.id})" style="background:#eee; color:#333;">åŒ¯å‡ºTCX</button>
        <button onclick="deleteRec(${r.id})" style="background:var(--danger); color:white;">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}

/* ---------------- åŠŸèƒ½: æŸ¥çœ‹ã€ä¿®æ­£ã€åˆªé™¤ ---------------- */
function editDist(id) {
  const records = JSON.parse(localStorage.getItem('run_history_v2.3'));
  const idx = records.findIndex(r => r.id === id);
  const newVal = prompt("è«‹è¼¸å…¥ä¿®æ­£å¾Œçš„é‡Œç¨‹ (km):", records[idx].dist);
  if (newVal !== null && !isNaN(newVal)) {
    records[idx].dist = parseFloat(newVal).toFixed(3);
    localStorage.setItem('run_history_v2.3', JSON.stringify(records));
    renderHistory();
  }
}

function deleteRec(id) {
  if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
    const records = JSON.parse(localStorage.getItem('run_history_v2.3')).filter(r => r.id !== id);
    localStorage.setItem('run_history_v2.3', JSON.stringify(records));
    renderHistory();
  }
}

function viewTrack(id) {
  const r = JSON.parse(localStorage.getItem('run_history_v2.3')).find(r => r.id === id);
  if (!r.points || r.points.length < 2) return alert("è»Œè·¡é»ä¸è¶³ï¼Œç„¡æ³•é¡¯ç¤º");
  
  const modal = document.getElementById('trackModal');
  const canvas = document.getElementById('trackCanvas');
  const ctx = canvas.getContext('2d');
  
  modal.style.display = 'flex';
  canvas.width = window.innerWidth * 0.8;
  canvas.height = canvas.width;

  // è¨ˆç®—åº§æ¨™ç¸®æ”¾
  const lats = r.points.map(p => p.lat), lons = r.points.map(p => p.lon);
  const minLat = Math.min(...lats), maxLat = Math.max(...lats);
  const minLon = Math.min(...lons), maxLon = Math.max(...lons);
  const rangeLat = maxLat - minLat || 0.0001, rangeLon = maxLon - minLon || 0.0001;
  const padding = 40;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = '#ff6a00'; ctx.lineWidth = 4; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
  
  ctx.beginPath();
  r.points.forEach((p, i) => {
    const x = padding + (p.lon - minLon) / rangeLon * (canvas.width - padding * 2);
    const y = canvas.height - (padding + (p.lat - minLat) / rangeLat * (canvas.height - padding * 2));
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // æ¨™è¨»èµ·é»èˆ‡çµ‚é»
  ctx.fillStyle = 'green'; ctx.fillRect(padding + (lons[0]-minLon)/rangeLon*(canvas.width-padding*2)-5, canvas.height-(padding + (lats[0]-minLat)/rangeLat*(canvas.height-padding*2))-5, 10, 10);
  ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(padding + (lons[lons.length-1]-minLon)/rangeLon*(canvas.width-padding*2), canvas.height-(padding + (lats[lats.length-1]-minLat)/rangeLat*(canvas.height-padding*2)), 6, 0, Math.PI*2); ctx.fill();
}

function closeTrack() { document.getElementById('trackModal').style.display = 'none'; }

/* ---------------- å…¶ä»–è¼”åŠ© ---------------- */
function formatTime(s) { return Math.floor(s/60).toString().padStart(2,'0')+":"+(s%60).toString().padStart(2,'0'); }
function updatePace() { if(totalDist<5)return; document.getElementById('pace').innerText = formatTime(Math.floor(elapsedSec/(totalDist/1000))); }
function exportTCX(id) {
  const r = JSON.parse(localStorage.getItem('run_history_v2.3')).find(r => r.id === id);
  let tcx = `<?xml version="1.0" encoding="UTF-8"?><TrainingCenterDatabase xmlns="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2"><Activities><Activity Sport="Running"><Id>${new Date(r.id).toISOString()}</Id><Lap StartTime="${new Date(r.id).toISOString()}"><TotalTimeSeconds>${r.rawSec}</TotalTimeSeconds><DistanceMeters>${r.dist*1000}</DistanceMeters><Track>`;
  r.points.forEach(p => tcx += `<Trackpoint><Time>${p.time}</Time><Position><LatitudeDegrees>${p.lat}</LatitudeDegrees><LongitudeDegrees>${p.lon}</LongitudeDegrees></Position><DistanceMeters>${p.dist.toFixed(1)}</DistanceMeters></Trackpoint>`);
  tcx += `</Track></Lap></Activity></Activities></TrainingCenterDatabase>`;
  const blob = new Blob([tcx], {type:'application/tcx+xml'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Run_${r.id}.tcx`; a.click();
}

window.onload = () => { initTable(); renderHistory(); };
</script>
</body>
</html>
